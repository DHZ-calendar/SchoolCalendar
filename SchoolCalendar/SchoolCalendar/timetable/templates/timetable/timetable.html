{% extends 'timetable/base.html' %}
{% load i18n %}

{% block head %}
<!-- TODO: change using git submodule -->
<link rel="stylesheet" href="https://raw.githack.com/DHZ-calendar/timetable.js/develop/timetable.css"/>
<script src="https://raw.githack.com/DHZ-calendar/timetable.js/develop/timetable.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
{% endblock %}

{% block style %}  
.list-teachers:hover{
    color: #fff;
    background-color: #007bff;
    border-color: #007bff;
    cursor: pointer;
}
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row">
        <h3 class="col text-center">{% trans 'Plan a timetable' %}</h3>
    </div>
    <div class="row">
        <div class="col">
            {% trans 'School year:' %}
            <select id="school_year">
                {% for year in school_years %}
                    <option value="{{ year.id }}">{{ year }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col">
            {% trans 'Choose a class:' %}
            <select id="course_year" onchange="getClassSections()">
            </select>
            {% trans 'section:' %}
            <select id="course_section" onchange="getTeachers()">
            </select>
        </div>
    </div>
    <div class="row">
        <div class="col-10">
            <div class="row py-3">                
                <div class="col text-left">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="goPrevWeek()"><- {% trans 'Previous week'%}</button>
                </div>
                <div class="col text-right">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="goNextWeek()">{% trans 'Next week'%} -></button>
                </div>
            </div>
            <table class="container-fluid" id="calendar">
            </table>
        </div>
        <div class="col-2">
            {% trans 'List of teachers:' %}
            <ul class="list-group" id="teachers_list">
                                
            </ul>
        </div>
    </div>
</div>


{% endblock %}


{% block script %}
    let timetable;
    let currentDate;
    $(document).ready(() => {
        let cal = $("#calendar");
        timetable = new Timetable(cal, 7, 23);

        //find the first day of the week        
        currentDate = moment().day(1).toDate();

        loadData();
        getClassYears();
    });

    function loadData(){
        timetable.deleteAllEvents();
        timetable.deleteAllBlocks();
        getBlocks();


        let startDate = currentDate;
        let endDate = moment(startDate).add(6, 'days').toDate();

        timetable.setDays(new Date(startDate));

        getHolidays(startDate, endDate);
        getStages(startDate, endDate);
        getAssignments(startDate, endDate);
    }

    function goNextWeek(){
        currentDate = moment(currentDate).add(7, 'days').toDate();
        loadData();
    }
    function goPrevWeek(){
        currentDate = moment(currentDate).subtract(7, 'days').toDate();
        loadData();
    }

    function parseStringTime(time){
        let arr = time.split(':');
        let hours = parseInt(arr[0]);
        let min = parseInt(arr[1]);
        return { hours: hours, min: min };
    }
    function formatDate(date){
        if(date === undefined)
            return date;

        let frm = (x) => ("0" + x).slice(-2);
        return date.getFullYear() + "-" + frm(date.getMonth() + 1) + "-" + frm(date.getDate());
    }

    function getBlocks(){
        let url = "{% url 'hour_slot-list' %}";
        let data = {
            'school_year': $('#school_year').val()
        };
        $.get(url, data=data, function(data) {
            for(let slot of data){
                let starts_at = parseStringTime(slot.starts_at);
                let ends_at = parseStringTime(slot.ends_at);

                let block = new Block(slot.id, slot.hour_number + "Â° {% trans 'lecture' %}", slot.day_of_week, starts_at, ends_at);
                timetable.addBlock(block);
            }
        });
    }
    function getClassYears(){
        let url = "{% url 'year_only_course-list' %}";
        let data = {
            'school_year': $('#school_year').val()
        };
        $.get(url, data=data, function(data) {
            for(let year of data){
                $('#course_year').append(`<option value="${year.year}">${year.year}</option>`);
            }

            //update section select
            getClassSections();
        });
    }
    function getClassSections(){
        let url = "{% url 'section_only_course-list' %}";
        let data = {
            'school_year': $('#school_year').val(),
            'year': $('#course_year').val()
        };
        $('#course_section').empty();
        $.get(url, data=data, function(data) {
            for(let sect of data){
                $('#course_section').append(`<option value="${sect.id}">${sect.section}</option>`);
            }

            //update list of teachers
            getTeachers();

            //update assignments
            getAssignments();
        });
    }

    function getTeachers(){
        let url = "{% url 'hour_per_teacher_in_class-list' %}";
        let data = {
            'school_year': $('#school_year').val(),
            'course': $('#course_section').val()
        };
        $.get(url, data=data, function(data) {
            $('#teachers_list').empty();
            for(let tea of data){
                let html = `
                    <li class="list-group-item list-teachers" onclick="teacherClick(this, ${tea.teacher.id})">
                        <b>${tea.teacher.first_name} ${tea.teacher.last_name}</b> - ${tea.subject.name}<br/>
                        <span>{% trans 'Hours of theaching' %}: ${tea.hours} - {% trans 'B.E.S.' %}: ${tea.hours_bes}</span><br/>
                        <span>{% trans 'Missing hours' %}: ${tea.missing_hours} - {% trans 'B.E.S.' %}: ${tea.missing_hours_bes}</span><br/>
                    </li>`;
                $('#teachers_list').append(html);
            }
        });
    }

    function getAssignments(startDate, endDate){
        let url = "{% url 'assignments-list' %}";
        let data = {
            'school_year': $('#school_year').val(),
            'course': $('#course_section').val(),
            'from_date': formatDate(startDate),
            'to_date': formatDate(endDate)
        };
        timetable.deleteAllEvents();
        $.get(url, data=data, function(data) {
            for(let assign of data){
                if(assign.hour_slot !== undefined){
                    let teacher = assign.teacher.first_name + " " + assign.teacher.last_name;
                    let customEvent = new Event(assign.hour_slot, teacher, assign.subject.name);
                    let clickEvent = (event) => {
                        alert("Lecture " + event.lecture + ", teacher " + event.teacher);
                    };
                    timetable.addEvent(customEvent, assign.hour_slot, clickEvent);
                }
                else{
                    //TODO: assign custom id and create block if missing
                }
            }
        });
    }

    function getHolidays(startDate, endDate){
        let url = "{% url 'holiday-list' %}";
        let data = {
            'school_year': $('#school_year').val(),
            'from_date': formatDate(startDate),
            'to_date': formatDate(endDate)
        };
        $.get(url, data=data, function(data) {
            for(let day of data){
                let start = moment(day.start);
                let end = moment(day.end);
                while(start <= end) {
                    timetable.lockDay(start.weekday() - 1, day.name);
                    start.add(1, 'days');
                }
            }
        });
    }
    function getStages(startDate, endDate){
        let url = "{% url 'stage-list' %}";
        let data = {
            'school_year': $('#school_year').val(),
            'course': $('#course_section').val(),
            'from_date': formatDate(startDate),
            'to_date': formatDate(endDate)
        };
        $.get(url, data=data, function(data) {
            for(let day of data){
                let start = moment(day.start);
                let end = moment(day.end);
                while(start <= end) {
                    timetable.lockDay(start.weekday() - 1, day.name);
                    start.add(1, 'days');
                }
            }
        });
    }

    function teacherClick(btn, teacherId){
        btn = $(btn);

        if(!btn.hasClass('active')){
            btn.addClass('active');

            for(let blk of Object.keys(timetable.blocks)){
                timetable.getBlock(blk).setStateAvailable();
            }

            setLockedBlocksTeacher(teacherId);
        }
        else{
            btn.removeClass('active');

            timetable.resetAllBlocksStates();
        }
    }

    function setLockedBlocksTeacher(teacherId){
        let school_year = $('#school_year').val();
        let startDate = currentDate;
        let endDate = moment(startDate).add(6, 'days').toDate();

        let url = "/timetable/api/teacher_assignments/" + teacherId + "/" + school_year;
        let data = {
            'school_year': school_year,
            'from_date': formatDate(startDate),
            'to_date': formatDate(endDate)
        };
        $.get(url, data=data, function(data) {
            for(let block of data){
                if(block.hour_slot !== undefined){
                    timetable.getBlock(block.hour_slot).setStateDenied();
                }
                else{
                    //TODO: insert in a non standard block
                    console.log(block);
                }
            }
        });
    }
{% endblock %}
