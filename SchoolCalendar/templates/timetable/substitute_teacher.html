{% extends 'timetable/base.html' %}
{% load i18n %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'main.css' %}"/>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2.2.1/src/js.cookie.min.js"></script>
{% endblock %}

{% block style %}
.check-subsitute{
    margin-top: calc(50% - 10px) !important;
}
.teachers-list{
    max-height: 350px;
    overflow-y: auto;
}
.teachers-list-others{
    max-height: 200px;
    overflow-y: auto;
}
{% endblock %}

{% block body %}
<div class="container">
    <div class="row">
        <h3 class="col text-center">{% trans 'Substitute a teacher' %}</h3>
    </div>
    <div class="row p-1">
        <div class="col-6">
            {% trans 'School year:' %}
            <select id="school_year" class="form-control form-control-custom" onchange="getTeachers()">
                {% for year in school_years %}
                    <option value="{{ year.id }}">{{ year }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-6">
            {% trans 'Teachers:' %}
            <select id="teachers" class="form-control form-control-custom" onchange="">
            </select>
        </div>
    </div>
    <div class="row p-1">
        <div class="col-6">
            {% trans 'Choose a date:' %}
            <input type="text" class="form-control form-control-custom datepicker" id="date" data-date-format='dd/mm/yyyy' />
        </div>
        <div class="col-6">
            <button type="button" class="btn btn-success" onclick="getTeacherAssignments($(this))">{% trans 'Load lectures' %}</button>
        </div>
    </div>
    <div class="row">
        <div class="col-12 container">
            <div id="lectures" class="accordion mt-4">
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block script %}
    $(document).ready(() => {
        $('.datepicker').datepicker({
            dateFormat: 'dd-mm-yy'
        });
        getTeachers();
    });

    function getTeachers(){
        let url = "{% url 'teacher-list' %}";
        let data = {
            'school_year': $('#school_year').val()
        };
        $.get(url, data=data, function(data) {
            $("#teachers").empty();
            for(let tea of data){
                $("#teachers").append(`
                    <option value="${tea.id}">${tea.first_name} ${tea.last_name}</option>
                `);
            }
        });
    }

    function getTeacherAssignments(){
        let url = "{% url 'teacher_assignments-list' 1234 9999 %}"
            .replace('1234', $("#teachers").val())
            .replace('9999', $('#school_year').val());
        
        let date = moment($("#date").val(), 'DD-MM-YYYY').format('YYYY-MM-DD');
        let data = {
            'from_date': date,
            'to_date': date
        };
        $("#lectures").empty();
        $.get(url, data=data, function(data) {
            for(let assign of data){
                $("#lectures").append(`
                    <div class="card" id="card-${assign.id}">
                        <div class="card-header">
                            <h2 class="mb-0">
                                <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapse-${assign.id}" aria-expanded="false" aria-controls="collapse-${assign.id}">
                                    <b>${assign.subject.name}</b>&nbsp;${assign.hour_start.substring(0, 5)} - ${assign.hour_end.substring(0, 5)}&nbsp;
                                </button>
                            </h2>
                        </div>
                        <div id="collapse-${assign.id}" class="collapse" aria-labelledby="card-${assign.id}" data-parent="#lectures">
                            <div class="card-body text-center">
                                <b>{% trans 'Available teachers:' %}</b>
                                <ul class="list-group teachers-list col-12 my-2 text-left" id="sub_teachers-${assign.id}">
                                </ul>
                                <hr/>
                                <b>{% trans 'Other teachers: (the substitution will not be counted)' %}</b>
                                <ul class="list-group teachers-list teachers-list-others col-12 my-2 text-left" id="sub_teachers-others-${assign.id}">
                                </ul>
                                <button type="button" class="btn btn-success mt-2" assignId="${assign.id}" onclick="substituteTeacher($(this))">
                                    {% trans 'Make substitution' %}
                                </button>
                            </div>
                        </div>
                    </div>
                `);

                let substituteBlock = $("#lectures").find("ul#sub_teachers-" + assign.id);
                let substituteOthersBlock = $("#lectures").find("ul#sub_teachers-others-" + assign.id);
                getSubstituteTeachers(assign.id, substituteBlock, substituteOthersBlock);
            }
            if(data.length === 0){
                $("#lectures").html(`<b>{% trans 'No lectures found!' %}</b>`);
            }
        });
    }

    function getSubstituteTeachers(assignId, substSelect, substOthersSelect){
        let url = "{% url 'teacher_substitution-view' 1234 %}"
            .replace('1234', assignId);
        $.get(url, function(data) {
            substSelect.empty();
            for(let tea of data.available_teachers){
                substSelect.append(`
                    <li class="list-group-item row" style="display: flex;">
                        <div class="col-1 text-center">
                            <input class="check-subsitute" type="radio" name="radio-${assignId}" value="${tea.id}">
                        </div>
                        <div class="col-11">
                            <b>${tea.first_name} ${tea.last_name}</b><br/>
                            {% trans 'Hours of substitutions made:' %} ${tea.substitutions_made_so_far}<br/>
                            {% trans 'Has a lesson before:' %} ${tea.has_hour_before}<br/>
                            {% trans 'Has a lesson after:' %} ${tea.has_hour_after}<br/>
                        </div>
                    </li>
                `);
            }
            for(let tea of data.other_teachers){
                substOthersSelect.append(`
                    <li class="list-group-item row" style="display: flex;">
                        <div class="col-1 text-center">
                            <input class="check-subsitute" type="radio" name="radio-${assignId}" value="${tea.id}">
                        </div>
                        <div class="col-11">
                            <b>${tea.first_name} ${tea.last_name}</b><br/>
                            {% trans 'Hours of substitutions made:' %} ${tea.substitutions_made_so_far}<br/>
                            {% trans 'Has a lesson before:' %} ${tea.has_hour_before}<br/>
                            {% trans 'Has a lesson after:' %} ${tea.has_hour_after}<br/>
                        </div>
                    </li>
                `);
            }
        });
    }

    async function substituteTeacher(btn){
        let assignId = btn.attr("assignId");
        let teacherId = $("input[name=radio-" + assignId + "]:checked").val();
        
        if(teacherId !== undefined){
            let url = "{% url 'substitute_teacher_api-view' 1234 9999 %}"
                    .replace("1234", assignId)
                    .replace("9999", teacherId);
            let data = {
                csrfmiddlewaretoken: Cookies.get('csrftoken')
            }

            let res = await $.post(url, data=data);
        }
    }
{% endblock %}
